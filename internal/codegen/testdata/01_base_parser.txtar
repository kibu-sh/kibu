parse $WORK
cmp $WORK/src/pkg/auth/auth.gen.go exp/pkg/auth/auth.gen.go
cmp $WORK/gen/kibugen/wire_set.gen.go exp/gen/kibugen/wire_set.gen.go
! exists src/pkg/nope/nope.gen.go

parse $WORK
cmp exp/pkg/auth/auth.gen.go $WORK/src/pkg/auth/auth.gen.go
cmp exp/gen/kibugen/wire_set.gen.go $WORK/gen/kibugen/wire_set.gen.go

-- src/go.mod --
module github.com/example/module

-- exp/gen/kibugen/wire_set.gen.go --
// Code generated by kibu. DO NOT EDIT.

package kibugen

import (
	transport "github.com/kibu-sh/kibu/pkg/transport"
	httpx "github.com/kibu-sh/kibu/pkg/transport/httpx"
	middleware "github.com/kibu-sh/kibu/pkg/transport/middleware"
	temporal "github.com/kibu-sh/kibu/pkg/transport/temporal"
	auth "github.com/example/module/pkg/auth"
	example "github.com/example/module/pkg/example"
	middleware1 "github.com/example/module/pkg/middleware"
	wire "github.com/google/wire"
)

type HTTPHandlerFactoryDeps struct {
	AuthService        *auth.service
	ExampleService     *example.Service
	MiddlewareRegistry *middleware.Registry
}

func ProvideHTTPHandlers(deps *HTTPHandlerFactoryDeps) (handlers []*httpx.Handler) {
	handlers = append(handlers, deps.AuthService.HTTPHandlerFactory(
		deps.MiddlewareRegistry,
	)...)
	handlers = append(handlers, deps.ExampleService.HTTPHandlerFactory(
		deps.MiddlewareRegistry,
	)...)
	return
}

type WorkerFactoryDeps struct {
	AuthActivities    *auth.activities
	AuthWorkflows     *auth.workflows
	ExampleActivities *example.Activities
	ExampleWorkflows  *example.Workflows
}

func ProvideWorkers(deps *WorkerFactoryDeps) (workers []*temporal.Worker) {
	workers = append(workers, deps.AuthActivities.WorkerFactory()...)
	workers = append(workers, deps.AuthWorkflows.WorkerFactory()...)
	workers = append(workers, deps.ExampleActivities.WorkerFactory()...)
	workers = append(workers, deps.ExampleWorkflows.WorkerFactory()...)
	return
}

type MiddlewareDeps struct {
	MiddlewareMiddleware *middleware1.Middleware
}

func ProvideMiddleware(deps *MiddlewareDeps) (reg *middleware.Registry) {
	reg = middleware.NewRegistry()
	reg.Register(middleware.RegistryItem{
		Order:      0,
		Tags:       []string{"global"},
		Middleware: transport.NewMiddleware(deps.MiddlewareMiddleware.GlobalMiddleware),
	})
	reg.Register(middleware.RegistryItem{
		Order:      0,
		Tags:       []string{"auth"},
		Middleware: transport.NewMiddleware(deps.MiddlewareMiddleware.LoadUser),
	})
	reg.Register(middleware.RegistryItem{
		Order:      1,
		Tags:       []string{"auth"},
		Middleware: transport.NewMiddleware(deps.MiddlewareMiddleware.LoadCustomer),
	})
	reg.Register(middleware.RegistryItem{
		Order:      2,
		Tags:       []string{"auth"},
		Middleware: transport.NewMiddleware(deps.MiddlewareMiddleware.CheckPermissions),
	})
	reg.Register(middleware.RegistryItem{
		Order:      0,
		Tags:       []string{"cache"},
		Middleware: transport.NewMiddleware(deps.MiddlewareMiddleware.CacheMiddleware),
	})
	return
}

var WireSet = wire.NewSet(
	ProvideHTTPHandlers,
	ProvideWorkers,
	ProvideMiddleware,
	wire.Struct(new(HTTPHandlerFactoryDeps), "*"),
	wire.Struct(new(WorkerFactoryDeps), "*"),
	wire.Struct(new(MiddlewareDeps), "*"),
	wire.Struct(new(auth.service), "*"),
	wire.Struct(new(example.Service), "*"),
	wire.Struct(new(auth.activities), "*"),
	wire.Struct(new(auth.activities__Proxy), "*"),
	wire.Struct(new(auth.workflows), "*"),
	wire.Struct(new(auth.workflows__Proxy), "*"),
	wire.Struct(new(auth.workflows__Client), "*"),
	wire.Struct(new(example.Activities), "*"),
	wire.Struct(new(example.Activities__Proxy), "*"),
	wire.Struct(new(example.Workflows), "*"),
	wire.Struct(new(example.Workflows__Proxy), "*"),
	wire.Struct(new(example.Workflows__Client), "*"),
	auth.InitActivityDeps,
	auth.InitServiceDeps,
	auth.InitWorkflowDeps,
	wire.Struct(new(auth.StructProvider), "*"),
	wire.Struct(new(middleware1.Middleware), "*"),
)
-- exp/pkg/auth/auth.gen.go --
// Code generated by kibu. DO NOT EDIT.

package auth

import (
	"context"
	transport "github.com/kibu-sh/kibu/pkg/transport"
	httpx "github.com/kibu-sh/kibu/pkg/transport/httpx"
	middleware "github.com/kibu-sh/kibu/pkg/transport/middleware"
	temporal "github.com/kibu-sh/kibu/pkg/transport/temporal"
	client "go.temporal.io/sdk/client"
	workflow "go.temporal.io/sdk/workflow"
)

func (svc *service) HTTPHandlerFactory(middlewareReg *middleware.Registry) []*httpx.Handler {
	return []*httpx.Handler{
		httpx.NewHandler("/verify", transport.NewEndpoint(svc.Verify).WithMiddleware(
			middlewareReg.Get(middleware.GetParams{
				ExcludeAuth: true,
				Tags:        []string{"example", "cache"},
			})...,
		)).WithMethods("GET"),
	}
}
func (act *activities) WorkerFactory() []*temporal.Worker {
	return []*temporal.Worker{
		&temporal.Worker{
			Name:      "auth.activities.Verify",
			Type:      "activity",
			TaskQueue: "default",
			Handler:   act.Verify,
		},
	}
}

type activities__Proxy struct{}

func (p activities__Proxy) Verify(ctx workflow.Context, req VerifyRequest) temporal.Future[VerifyResponse] {
	return temporal.NewFuture[VerifyResponse](
		workflow.ExecuteActivity(ctx, "auth.activities.Verify", req),
	)
}
func (wkr *workflows) WorkerFactory() []*temporal.Worker {
	return []*temporal.Worker{
		&temporal.Worker{
			Name:      "auth.workflows.Verify",
			Type:      "workflow",
			TaskQueue: "default",
			Handler:   wkr.Verify,
		},
	}
}

type workflows__Client struct {
	Temporal client.Client
}

func (c workflows__Client) Verify(ctx context.Context, id string, req VerifyRequest) (temporal.WorkflowRun[VerifyResponse], error) {
	return temporal.NewWorkflowRunWithErr[VerifyResponse](
		c.Temporal.ExecuteWorkflow(ctx, client.StartWorkflowOptions{
			ID:        id,
			TaskQueue: "default",
		}, "auth.workflows.Verify", req),
	)
}

type workflows__Proxy struct{}

func (p workflows__Proxy) Verify(ctx workflow.Context, req VerifyRequest) temporal.ChildWorkflowFuture[VerifyResponse] {
	return temporal.NewChildWorkflowFuture[VerifyResponse](
		workflow.ExecuteChildWorkflow(ctx, "auth.workflows.Verify", req),
	)
}
-- src/pkg/example/example.go --
package example

import (
	"context"
)

//kibu:service
type Service struct {}

type ExampleRequest struct {}
type ExampleResponse struct {}

//kibu:endpoint path=/example method=POST,GET
func (s *Service) Example(ctx context.Context, req ExampleRequest) (res ExampleResponse, err error) {
	return
}

//kibu:worker workflow
type Workflows struct {}

//kibu:workflow
func (*Workflows) Example(ctx context.Context, req ExampleRequest) (res ExampleResponse, err error) {
	return
}

//kibu:worker activity
type Activities struct {}

//kibu:activity
func (Activities) Example(ctx context.Context, req ExampleRequest) (res ExampleResponse, err error) {
	return
}
-- src/pkg/auth/z_auth.go --
package auth

// service handles authentication
//kibu:service
type service struct {}
-- src/pkg/auth/auth_verify.go --
package auth

import ("context")

type VerifyRequest struct {}
type VerifyResponse struct {}

// Send sends an authentication request
//   Here's some other comment related stuff
//kibu:endpoint path=/verify method=GET tag=example tag=cache public
func (s *service) Verify(ctx context.Context, req VerifyRequest) (res VerifyResponse, err error) {
	return
}
-- src/pkg/auth/auth_worker.go --
package auth

import ("context")

// service handles authentication
//kibu:worker workflow
type workflows struct {}

// Verify sends an authentication request
//   Here's some other comment related stuff
//kibu:workflow
func (*workflows) Verify(ctx context.Context, req VerifyRequest) (res VerifyResponse, err error) {
	return
}

// service handles authentication
//kibu:worker activity
type activities struct {}

// Verify sends an authentication request
//   Here's some other comment related stuff
//kibu:activity
func (activities) Verify(ctx context.Context, req VerifyRequest) (res VerifyResponse, err error) {
	return
}

//kibu:provider
func InitServiceDeps() error {
	return nil
}

//kibu:provider
func InitWorkflowDeps() error {
	return nil
}

//kibu:provider
func InitActivityDeps() error {
	return nil
}

//kibu:provider
type StructProvider struct {}
-- src/pkg/nope/nope.go --
package nope

type nope struct{}
-- src/pkg/middleware/middleware.go --
package middleware

import (
	"github.com/kibu-sh/kibu/pkg/transport"
)

type Middleware struct {}

//kibu:middleware
func (m *Middleware) GlobalMiddleware(tctx transport.Context, next transport.Handler) error { return }

//kibu:middleware tag=auth order=0
func (m *Middleware) LoadUser(tctx transport.Context, next transport.Handler) error { return }

//kibu:middleware tag=auth order=1
func (m *Middleware) LoadCustomer(tctx transport.Context, next transport.Handler) error { return }

//kibu:middleware tag=auth order=2
func (m *Middleware) CheckPermissions(tctx transport.Context, next transport.Handler) error { return }

//kibu:middleware tag=cache
func (m *Middleware) CacheMiddleware(tctx transport.Context, next transport.Handler) error { return }
